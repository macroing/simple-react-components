"use client";
import{AnimatePresence as e,motion as a}from"framer-motion";import{useRef as i,useState as t,useEffect as s}from"react";import n from"./Button.js";import o from"./ChatMessage.js";import l from"./FileInputButtonLabel.js";import r from"./ImageViewer.js";import c from"./TextArea.js";import{DEFAULT_IMAGE as d}from"./ChatUtilities.js";import m from"./Chat.module.css.js";import{jsx as h,jsxs as g}from"react/jsx-runtime";const f={maximized:{height:"75vh",opacity:1},minimized:{height:"auto",opacity:1}};function p(p){const u=p.chat,y=p.chatConfiguration,v=p.chatHandler,C=p.chatIndex,N=p.chats,b=p.defaultImage||d,T=p.linkFactory||function(e,a){return h("a",{href:e,children:a})},w=p.setChats,I=p.styles||m,x=i(),k=i(),M=i(),[H,j]=t([]),[z,_]=t([]),[D,F]=t(null),[L,U]=t(!1),[V,B]=t(!1),[S,A]=t(!1),[K,P]=t(!1),[R,q]=t(!0),[E,G]=t(!1),[J,O]=t(null),[Q,W]=t(""),[X,Y]=t([]),[Z,$]=t("");function ee(e){$(function(e){return v?.onFilterText?v.onFilterText(e):e}(e.target.value))}function ae(e){q(!1),setTimeout((()=>{v?.onChatClose&&v.onChatClose(u,N,w)}),100)}function ie(e){B(!0),v?.onLoadChatMessages&&v.onLoadChatMessages(u,N,w)}function te(e){A(!1)}function se(e){A(!0)}function ne(e){v?.onSendChatMessage&&v.onSendChatMessage(u,Z,N,w),$("")}function oe(e){v?.onType&&v.onType(u,N,w)}function le(e){e.target.files&&e.target.files.length>0&&F(e.target.files[0])}function re(e,a=!1){e?.src&&(U(a),G(!0),W(e.src))}return s((()=>{u?.body?.chatMessages&&u.body.chatMessages.length>=0&&j([...u.body.chatMessages].reverse()),u?.body?.images&&u.body.images.length>=0&&Y([...u.body.images].map((e=>e?.src||b))),u?.footer?.lastTimeTyped&&u.footer.lastTimeTyped instanceof Date&&O(u.footer.lastTimeTyped)}),[u]),s((()=>{V||H.length===z.length||(x.current.scrollTop=x.current.scrollHeight),B(!1),_(H)}),[H]),s((()=>{D&&(v?.onUploadImage&&v.onUploadImage(u,D,N,w),F(null))}),[D]),s((()=>{S||setTimeout((()=>{x.current.scrollTop=x.current.scrollHeight}),200)}),[S]),s((()=>{J instanceof Date&&(new Date).getTime()-J.getTime()<=5e3&&(P(!0),clearTimeout(M.current),M.current=setTimeout((()=>{P(!1)}),5e3))}),[J]),h(e,{children:R&&g("div",{className:I.chat,tabIndex:0,children:[g(a.div,{animate:S?"minimized":"maximized",className:I.content,exit:{height:0,opacity:0},initial:{height:0,opacity:0},transition:{duration:.1},variants:f,children:[g("div",{className:I.header,children:[g("div",{className:I.image,children:[h("img",{alt:u?.header?.image?.alt||"",src:u?.header?.image?.src||b}),u?.header?.isLoggedIn&&h("span",{"aria-hidden":!0,className:"fa fa-circle "+I.logged_in})]}),h("div",{className:I.title,children:T(u?.header?.title?.href||"/",u?.header?.title?.text||"")}),g("div",{className:I.icons,children:[h(a.button,{className:I.icon,onClick:S?te:se,transition:{type:"spring",stiffness:500},whileHover:{scale:1.03},children:h("span",{"aria-hidden":!0,className:S?"fa fa-window-maximize":"fa fa-window-minimize"})}),h(a.button,{className:I.icon+" "+I.icon_close,onClick:ae,transition:{type:"spring",stiffness:500},whileHover:{scale:1.03},children:h("span",{"aria-hidden":!0,className:"fa fa-times-circle"})})]})]}),g("div",{className:I.body,ref:x,style:S?{display:"none"}:void 0,children:[u?.body?.page&&u?.body?.pages&&u.body.page<u.body.pages&&h("div",{className:I.load_chat_messages,children:h(n,{onClick:ie,children:u?.body?.loadChatMessagesText||"Load more..."})}),H.map(((e,a)=>h(o,{chat:u,chatConfiguration:y,chatHandler:v,chatMessage:e,chats:N,defaultImage:b,setChats:w,viewImage:re},e?.key||"chat-message-"+(H.length-a))))]}),u?.uploadedImages&&u?.uploadedImages.length>0&&h("div",{className:I.uploaded_images,style:S?{display:"none"}:void 0,children:u?.uploadedImages.map(((e,i)=>g(a.div,{className:I.uploaded_image,onClick:a=>re(e),transition:{type:"spring",stiffness:500},whileHover:{scale:1.03},children:[h("img",{alt:e?.alt||"",src:e?.src||b}),h(a.div,{className:I.close,onClick:a=>function(e,a){e.stopPropagation(),v?.onDeleteUploadedImage&&v.onDeleteUploadedImage(u,a,N,w)}(a,e),transition:{type:"spring",stiffness:700},whileHover:{scale:1.2},children:h("span",{"aria-hidden":!0,className:"fa fa-times-circle"})})]},e?.key||"uploaded-image-"+i)))}),g("div",{className:I.footer,style:S?{display:"none"}:void 0,children:[h("div",{className:I.textarea,children:h(c,{onChange:ee,onKeyDown:oe,resize:!1,rows:3,style:{width:"100%"},value:Z})}),g("div",{className:I.controls,children:[h("div",{className:I.keyboard+(K?" "+I.keyboard_typing:""),children:h("span",{className:"fa fa-keyboard"})}),h(l,{accept:"image/*",htmlFor:"file-input"+C,id:"file-input"+C,inputRef:k,onChange:le,style:{width:"100%"},children:h("span",{"aria-hidden":!0,className:"fa fa-image"})}),h(a.button,{disabled:""===Z.trim(),onClick:ne,transition:""===Z.trim()?void 0:{type:"spring",stiffness:500},whileHover:""===Z.trim()?void 0:{scale:1.03},children:h("span",{"aria-hidden":!0,className:"fa fa-send"})})]})]})]}),h(r,{isVisible:E,setIsVisible:G,src:Q,srcs:L?X:void 0})]})})}export{p as default};
